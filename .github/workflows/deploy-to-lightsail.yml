# ğŸš€ GitHub Actions Workflow for Deploying to AWS Lightsail
# This workflow automatically deploys your app when you push to main branch

name: Deploy to AWS Lightsail

# ğŸ“‹ WHEN should this workflow run?
on:
  push:
    branches: [ main ]  # Run when code is pushed to main branch
  workflow_dispatch:    # Allow manual trigger from GitHub UI

# ğŸ”’ Environment variables (we'll set these in GitHub secrets)
env:
  LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}      # Your server IP
  LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}      # Usually 'ubuntu'
  LIGHTSAIL_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}    # Your SSH private key
  
  # ğŸ—„ï¸ Database credentials
  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

# ğŸƒâ€â™‚ï¸ JOBS - What tasks should GitHub Actions perform?
jobs:
  deploy:
    name: Deploy to Lightsail Server
    runs-on: ubuntu-latest  # Use Ubuntu server for this job
    
    steps:
    # ğŸ“¥ Step 1: Download your code from GitHub
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # ğŸ” Step 2: Setup SSH connection to your Lightsail server
    - name: ğŸ” Setup SSH
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        
        # Add your server's SSH key
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
        chmod 600 ~/.ssh/lightsail_key
        
        # Add server to known hosts (prevents SSH warnings)
        ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

    # ğŸš€ Step 3: Deploy to your Lightsail server
    - name: ğŸš€ Deploy PostgreSQL Container
      env:
        # Pass database credentials to the deployment
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        # Connect to your server and run deployment commands
        ssh -i ~/.ssh/lightsail_key ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'EOF'
          
          # Navigate to project directory (create if doesn't exist)
          cd /home/ubuntu/forewarn-ibf-portal || {
            echo "ğŸ“ Creating project directory..."
            mkdir -p /home/ubuntu/forewarn-ibf-portal
            cd /home/ubuntu/forewarn-ibf-portal
          }
          
          # ğŸ“¥ Pull latest code from GitHub
          echo "ğŸ“¥ Pulling latest code..."
          if [ -d ".git" ]; then
            git pull origin main
          else
            git clone https://github.com/afnan2013/forewarn-ibf-portal.git .
          fi
          
          # ğŸ” Create .env file with database credentials
          echo "ğŸ” Setting up environment variables..."
          echo "POSTGRES_DB=${POSTGRES_DB}" > .env
          echo "POSTGRES_USER=${POSTGRES_USER}" >> .env
          echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}" >> .env
          
          # ğŸ›‘ Stop existing containers (if any)
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose -f docker-compose.dev.yml down || true
          
          # ğŸš€ Start PostgreSQL container
          echo "ğŸš€ Starting PostgreSQL container..."
          docker-compose -f docker-compose.dev.yml up -d postgres
          
          # âœ… Check if container is running
          echo "âœ… Checking container status..."
          docker-compose -f docker-compose.dev.yml ps
          
          # ğŸ“Š Show logs
          echo "ğŸ“Š Container logs:"
          docker-compose -f docker-compose.dev.yml logs --tail=20 postgres
          
        EOF

    # ğŸ“§ Step 4: Notify about deployment status
    - name: ğŸ“§ Deployment Complete
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“ Server: ${{ secrets.LIGHTSAIL_HOST }}"
        echo "ğŸ˜ PostgreSQL should be running on port 5432"
